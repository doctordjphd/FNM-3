<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MTG Events - NJComicStop</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: 'Arial', sans-serif;
          background: white;
          color: black;
          line-height: 1.6;
      }
      
      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 0 20px;
      }
      
      /* Header Styles */
      header {
          border-bottom: 6px solid black;
          padding: 25px 0;
          background: white;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      
      .header-content {
          display: flex;
          align-items: center;
          justify-content: space-between;
          flex-wrap: wrap;
      }
      
      .logo-section {
          display: flex;
          align-items: center;
          gap: 25px;
      }
      
      .logo-link {
          text-decoration: none;
          transition: transform 0.3s ease;
      }
      
      .logo-link:hover {
          transform: scale(1.05);
      }
      
      .logo {
          width: 140px;
          height: 140px;
          filter: contrast(200%);
          border: 3px solid black;
          border-radius: 10px;
          padding: 5px;
          background: white;
      }
      
      .title-section h1 {
          font-size: 1.6rem;
          font-weight: 900;
          margin-bottom: 8px;
          text-shadow: 2px 2px 0px #ddd;
          letter-spacing: 1px;
      }
      
      /* Reservation Section */
      .reservation-section {
          background: black;
          color: white;
          padding: 80px 0;
          position: relative;
          overflow: hidden;
      }
      
      .reservation-section::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="1" fill="white" opacity="0.1"/><circle cx="10" cy="90" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
          pointer-events: none;
      }
      
      .reservation-title {
          text-align: center;
          font-size: 3.2rem;
          margin-bottom: 50px;
          font-weight: 900;
          text-shadow: 3px 3px 0px #666;
          letter-spacing: 3px;
          position: relative;
          z-index: 1;
      }
      
      .reservation-card {
          background: white;
          color: black;
          border: 6px solid white;
          border-radius: 15px;
          padding: 50px;
          max-width: 650px;
          margin: 0 auto;
          box-shadow: 0 15px 35px rgba(0,0,0,0.3);
          position: relative;
          z-index: 1;
          transform: rotate(1deg);
      }
      
      .card-title {
          margin-bottom: 25px;
          font-size: 1.8rem;
          font-weight: bold;
          display: flex;
          align-items: center;
          gap: 10px;
      }
      
      .date-selection {
          margin-bottom: 35px;
          border: 2px solid #eee;
          border-radius: 8px;
          padding: 15px;
          background: #f9f9f9;
      }
      
      .date-option {
          display: block;
          margin-bottom: 12px;
          padding: 15px;
          cursor: pointer;
          border-radius: 8px;
          transition: all 0.3s ease;
          border: 2px solid transparent;
      }
      
      .date-option:hover {
          background: #f0f0f0;
          border-color: black;
          transform: translateX(5px);
      }
      
      .date-option input[type="radio"] {
          margin-right: 12px;
          transform: scale(1.2);
      }
      
      .seat-availability {
          font-size: 0.9rem;
          color: #e67e22;
          font-weight: bold;
          margin-top: 5px;
          margin-left: 28px;
      }
      
      .seat-selection {
          margin-bottom: 25px;
          border: 2px solid #eee;
          border-radius: 8px;
          padding: 15px;
          background: #f9f9f9;
      }
      
      .seat-selection label {
          display: block;
          margin-bottom: 10px;
          font-weight: bold;
          font-size: 1.1rem;
      }
      
      .seat-selection select {
          width: 100%;
          padding: 10px;
          border: 2px solid black;
          border-radius: 5px;
          font-size: 1rem;
          background: white;
      }
      
      .price-section {
          border-top: 3px solid black;
          padding-top: 25px;
          margin-top: 25px;
      }
      
      .price-display {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 25px;
          padding: 20px;
          background: #f8f9fa;
          border-radius: 10px;
          border: 2px solid black;
      }
      
      .price-label {
          font-weight: bold;
          font-size: 1.3rem;
      }
      
      .price {
          font-size: 2.5rem;
          font-weight: 900;
          color: black;
          text-shadow: 1px 1px 0px #ddd;
      }
      
      .disclaimer {
          background: #fff3cd;
          border: 2px solid #ffc107;
          padding: 15px;
          margin: 20px 0;
          border-radius: 8px;
          font-size: 0.95rem;
          font-weight: bold;
          color: #856404;
          text-align: center;
      }
      
      .prize-info {
          background: #f0f0f0;
          padding: 20px;
          margin: 20px 0;
          border-left: 6px solid black;
          border-radius: 8px;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      
      .prize-info p {
          margin: 5px 0;
          font-weight: bold;
          color: black;
          font-size: 1.1rem;
      }
      
      .hygiene-note {
          font-size: 0.95rem;
          color: #555;
          text-align: center;
          margin-top: 15px;
          font-weight: bold;
          text-decoration: underline;
      }
      
      .payment-note {
          font-size: 0.9rem;
          color: #666;
          text-align: center;
          margin-top: 15px;
          font-style: italic;
      }
      
      /* Loading and Message States */
      .loading {
          opacity: 0.7;
          pointer-events: none;
      }

      .success-message {
          background: #d4edda;
          border: 2px solid #28a745;
          color: #155724;
          padding: 15px;
          border-radius: 8px;
          margin: 20px 0;
          text-align: center;
          font-weight: bold;
      }

      .error-message {
          background: #f8d7da;
          border: 2px solid #dc3545;
          color: #721c24;
          padding: 15px;
          border-radius: 8px;
          margin: 20px 0;
          text-align: center;
          font-weight: bold;
      }

      .loading-message {
          background: #e2e3e5;
          border: 2px solid #6c757d;
          color: #495057;
          padding: 15px;
          border-radius: 8px;
          margin: 20px 0;
          text-align: center;
          font-weight: bold;
      }
      
      /* Footer */
      footer {
          border-top: 6px solid black;
          padding: 60px 0;
          text-align: center;
          background: white;
      }
      
      .footer-title {
          font-size: 1.5rem;
          font-weight: bold;
          margin-bottom: 15px;
      }
      
      .footer-link {
          color: #666;
          font-size: 1.1rem;
          margin-bottom: 25px;
          text-decoration: none;
          transition: color 0.3s ease;
      }
      
      .footer-link:hover {
          color: black;
          text-decoration: underline;
      }
      
      .footer-note {
          font-size: 1rem;
          color: #999;
          font-style: italic;
      }
      
      /* Employee Link */
      .employee-link {
          position: fixed;
          bottom: 30px;
          right: 30px;
          background: black;
          color: white;
          padding: 15px 25px;
          text-decoration: none;
          border: 3px solid black;
          font-weight: bold;
          border-radius: 25px;
          box-shadow: 4px 4px 0px #666;
          transition: all 0.3s ease;
          z-index: 1000;
      }
      
      .employee-link:hover {
          background: #333;
          transform: translateY(-3px);
          box-shadow: 6px 6px 0px #666;
      }
      
      /* Responsive Design */
      @media (max-width: 768px) {
          .title-section h1 {
              font-size: 2rem;
          }
          
          .reservation-title {
              font-size: 2.5rem;
          }
          
          .header-content {
              flex-direction: column;
              gap: 25px;
              text-align: center;
          }
          
          .reservation-card {
              padding: 30px;
              transform: none;
          }
      }
      
      /* Animation for page load */
      @keyframes fadeInUp {
          from {
              opacity: 0;
              transform: translateY(30px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }
      
      .reservation-card {
          animation: fadeInUp 0.8s ease-out;
      }

      /* Debug panel */
      .debug-panel {
          background: #f8f9fa;
          border: 2px solid #6c757d;
          padding: 15px;
          margin-top: 20px;
          border-radius: 8px;
          font-family: monospace;
          font-size: 12px;
          white-space: pre-wrap;
          max-height: 200px;
          overflow-y: auto;
      }
      
      .debug-toggle {
          background: #6c757d;
          color: white;
          border: none;
          padding: 5px 10px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
          margin-top: 10px;
      }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
      <div class="container">
          <div class="header-content">
              <div class="logo-section">
                  <a href="https://njcomicstop.com" class="logo-link" target="_blank">
                      <img src="logo.png" alt="NJComicStop Logo" class="logo">
                  </a>
                  <div class="title-section">
                      <h1>MTG EVENTS</h1>
                  </div>
              </div>
          </div>
      </div>
  </header>

  <!-- Reservation Section -->
  <section class="reservation-section">
      <div class="container">
          <h2 class="reservation-title">Seat Reservation Info</h2>
          
          <div class="reservation-card">
              <h3 class="card-title">
                🗓️ Upcoming Events
              </h3>

              <div id="messageContainer"></div>

              <div class="date-selection" id="dateSelection">
                  <div class="loading-message">Loading events...</div>
              </div>

              <div class="seat-selection">
                  <label for="seatCount">Number of Seats:</label>
                  <select id="seatCount" onchange="updatePrice()">
                      <option value="1">1 Seat</option>
                      <option value="2">2 Seats</option>
                      <option value="3">3 Seats</option>
                      <option value="4">4 Seats</option>
                  </select>
              </div>

              <div class="price-section">
                  <div class="price-display">
                      <span class="price-label">Total Cost:</span>
                      <span class="price" id="totalPrice">$10.00</span>
                  </div>

                  <div class="disclaimer">
                      Non-refundable, all reservations are final. Cancellations do not warrant a refund for any reason. These events are not sanctioned or registered with Wizards of the Coast.
                  </div>
                  
                  <div class="prize-info">
                      <p>Participation: 1 Free Pack</p>
                      <p>🥈: + 1 Free Pack</p>
                      <p>🏆: + 1 Free Pack & Free Seat Reservation at next week's FNM Commander event</p>
                  </div>
                  
                  <div id="paypal-button-container">
                      <div class="loading-message">Loading payment options...</div>
                  </div>

                  <p class="hygiene-note">
                      Please come showered, clean and use deodorant. If your hygiene is an interruption you will be asked to leave and lose your seat with no refund. Thank you!
                  </p>
                  
                  <p class="payment-note">
                      Secure payment processing through PayPal
                  </p>
                  
                  <button id="debugToggle" class="debug-toggle" onclick="toggleDebug()">Show Debug Info</button>
                  <div id="debugPanel" class="debug-panel" style="display: none;"></div>
              </div>
          </div>
      </div>
  </section>

  <!-- Footer -->
  <footer>
      <div class="container">
          <p class="footer-title">NEW JERSEY COMIC STOP</p>
          <a href="https://njcomicstop.com" class="footer-link" target="_blank">Visit us at NJcomicstop.com</a>
          <p class="footer-note">Reservations are confirmed only after payment completion</p>
      </div>
  </footer>

  <!-- Employee Link -->
  <a href="#" class="employee-link" id="managerLink" target="_blank">
      👨‍💼 Manager Dashboard
  </a>

  <script>
      let selectedDate = '';
      let seatCount = 1;
      let CONFIG = null;
      let paypalLoaded = false;
      let debugInfo = [];
      
      // Try multiple possible backend URLs
      const POSSIBLE_BACKENDS = [
          'https://mtg-webhook-manager.vercel.app',
          'https://paypal-webhook-issue.vercel.app',
          'https://mtg-events.vercel.app'
      ];

      // Debug logging function
      function logDebug(message, data = null) {
          const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
          let logMessage = `[${timestamp}] ${message}`;
          if (data) {
              try {
                  logMessage += `: ${JSON.stringify(data)}`;
              } catch (e) {
                  logMessage += `: [Object]`;
              }
          }
          debugInfo.push(logMessage);
          console.log(logMessage);
          
          // Update debug panel if visible
          const debugPanel = document.getElementById('debugPanel');
          if (debugPanel && debugPanel.style.display !== 'none') {
              debugPanel.textContent = debugInfo.join('\n');
              debugPanel.scrollTop = debugPanel.scrollHeight;
          }
      }
      
      function toggleDebug() {
          const debugPanel = document.getElementById('debugPanel');
          const debugToggle = document.getElementById('debugToggle');
          
          if (debugPanel.style.display === 'none') {
              debugPanel.style.display = 'block';
              debugPanel.textContent = debugInfo.join('\n');
              debugPanel.scrollTop = debugPanel.scrollHeight;
              debugToggle.textContent = 'Hide Debug Info';
          } else {
              debugPanel.style.display = 'none';
              debugToggle.textContent = 'Show Debug Info';
          }
      }

      // Initialize configuration and load PayPal
      async function initializeApp() {
          try {
              showMessage('Loading configuration...', 'loading');
              logDebug('Initializing app');
              
              let configResponse = null;
              let workingBackend = null;
              
              // Try each possible backend URL
              for (const backendUrl of POSSIBLE_BACKENDS) {
                  try {
                      logDebug(`Trying backend: ${backendUrl}`);
                      
                      // Use no-cors mode first to test connectivity
                      const pingResponse = await fetch(`${backendUrl}/api/test`, {
                          method: 'HEAD',
                          mode: 'no-cors'
                      }).catch(e => {
                          logDebug(`Ping failed for ${backendUrl}`, e.message);
                          return null;
                      });
                      
                      if (pingResponse) {
                          logDebug(`Ping successful for ${backendUrl}`);
                          
                          // Now try the actual config endpoint
                          const response = await fetch(`${backendUrl}/api/config`, {
                              method: 'GET',
                              mode: 'cors',
                              credentials: 'omit',
                              headers: {
                                  'Accept': 'application/json'
                              }
                          });
                          
                          logDebug(`Config response status: ${response.status}`);
                          
                          if (response.ok) {
                              configResponse = response;
                              workingBackend = backendUrl;
                              break;
                          }
                      }
                  } catch (e) {
                      logDebug(`Failed to connect to ${backendUrl}:`, e.message);
                      continue;
                  }
              }
              
              if (!configResponse) {
                  throw new Error('Could not connect to any backend server');
              }
              
              CONFIG = await configResponse.json();
              logDebug('Config loaded:', CONFIG);
              
              // Store the working backend for future requests
              window.BACKEND_URL = workingBackend;
              logDebug(`Using backend: ${window.BACKEND_URL}`);
              
              // Update manager dashboard link
              const managerLink = document.getElementById('managerLink');
              if (managerLink && CONFIG.managerDashboardUrl) {
                  managerLink.href = CONFIG.managerDashboardUrl;
              }
              
              // Load PayPal SDK dynamically
              await loadPayPalSDK();
              
              // Load events and availability
              await loadEvents();
              
              clearMessage();
              
          } catch (error) {
              logDebug('Failed to initialize app:', error.message);
              showMessage(`❌ Failed to load payment system. Please refresh the page or try again later. (Error: ${error.message})`, 'error');
          }
      }

      // Load PayPal SDK dynamically
      function loadPayPalSDK() {
          return new Promise((resolve, reject) => {
              if (paypalLoaded || window.paypal) {
                  logDebug('PayPal SDK already loaded');
                  resolve();
                  return;
              }
              
              logDebug('Loading PayPal SDK with client ID:', CONFIG.paypalClientId);
              const script = document.createElement('script');
              script.src = `https://www.paypal.com/sdk/js?client-id=${CONFIG.paypalClientId}&currency=USD`;
              script.onload = () => {
                  paypalLoaded = true;
                  logDebug('PayPal SDK loaded successfully');
                  resolve();
              };
              script.onerror = (e) => {
                  logDebug('Failed to load PayPal SDK:', e);
                  reject(new Error('Failed to load PayPal SDK'));
              };
              document.head.appendChild(script);
          });
      }

      // Load events and their availability
      async function loadEvents() {
          const container = document.getElementById('dateSelection');
          logDebug('Loading events');
          
          // Available event dates
          const events = [
              {
                  date: '2025-06-13',
                  display: 'Friday, June 13, 2025 - FNM Commander (8:30 PM - 10:30 PM)'
              },
              {
                  date: '2025-06-20',
                  display: 'Friday, June 20, 2025 - FNM Commander (8:30 PM - 10:30 PM)'
              },
              {
                  date: '2025-06-27',
                  display: 'Friday, June 27, 2025 - FNM Commander (8:30 PM - 10:30 PM)'
              }
          ];

          container.innerHTML = '';

          for (let i = 0; i < events.length; i++) {
              const event = events[i];
              
              try {
                  // Fetch real-time availability
                  logDebug(`Fetching availability for ${event.date}`);
                  const availResponse = await fetch(`${window.BACKEND_URL}/api/availability?date=${event.date}`, {
                      method: 'GET',
                      mode: 'cors',
                      credentials: 'omit',
                      headers: {
                          'Accept': 'application/json'
                      }
                  });
                  
                  let availability = { availableSeats: 20, maxSeats: 20 };
                  
                  if (availResponse.ok) {
                      availability = await availResponse.json();
                      logDebug(`Availability for ${event.date}:`, availability);
                  } else {
                      logDebug(`Failed to get availability for ${event.date}:`, await availResponse.text());
                  }

                  const label = document.createElement('label');
                  label.className = 'date-option';
                  label.innerHTML = `
                      <input type="radio" name="date" value="${event.date}" onchange="selectDate('${event.date}')" ${i === 0 ? 'checked' : ''}>
                      <strong>${event.display}</strong>
                      <div class="seat-availability">${availability.availableSeats}/${availability.maxSeats} seats remaining</div>
                  `;
                  container.appendChild(label);
              } catch (error) {
                  logDebug(`Failed to load availability for ${event.date}:`, error.message);
                  
                  // Fallback display
                  const label = document.createElement('label');
                  label.className = 'date-option';
                  label.innerHTML = `
                      <input type="radio" name="date" value="${event.date}" onchange="selectDate('${event.date}')" ${i === 0 ? 'checked' : ''}>
                      <strong>${event.display}</strong>
                      <div class="seat-availability">20/20 seats remaining</div>
                  `;
                  container.appendChild(label);
              }
          }

          // Auto-select first event
          if (events.length > 0) {
              selectDate(events[0].date);
          }
      }

      function selectDate(date) {
          selectedDate = date;
          logDebug(`Selected date: ${date}`);
          renderPayPalButton();
      }

      function updatePrice() {
          seatCount = parseInt(document.getElementById('seatCount').value);
          const totalPrice = seatCount * 10;
          document.getElementById('totalPrice').textContent = `$${totalPrice.toFixed(2)}`;
          logDebug(`Updated price: $${totalPrice.toFixed(2)} for ${seatCount} seats`);
          renderPayPalButton();
      }

      function showMessage(message, type = 'success') {
          const container = document.getElementById('messageContainer');
          const className = type === 'loading' ? 'loading-message' : `${type}-message`;
          container.innerHTML = `<div class="${className}">${message}</div>`;
          logDebug(`Message (${type}): ${message}`);
      }

      function clearMessage() {
          const container = document.getElementById('messageContainer');
          container.innerHTML = '';
          logDebug('Cleared messages');
      }

      function renderPayPalButton() {
          if (!selectedDate || !CONFIG || !paypalLoaded) {
              logDebug('Cannot render PayPal button yet', { 
                  selectedDate: !!selectedDate, 
                  config: !!CONFIG, 
                  paypalLoaded 
              });
              return;
          }

          const container = document.getElementById('paypal-button-container');
          container.innerHTML = '';
          logDebug('Rendering PayPal button');

          const totalAmount = seatCount * 10;
          const itemName = `Friday Night Magic Commander - ${selectedDate} - ${seatCount} Seat${seatCount > 1 ? 's' : ''}`;

          window.paypal.Buttons({
              createOrder: function(data, actions) {
                  logDebug('Creating PayPal order');
                  return actions.order.create({
                      purchase_units: [{
                          amount: {
                              value: totalAmount.toFixed(2),
                              currency_code: 'USD'
                          },
                          description: itemName,
                          custom_id: selectedDate,
                          items: [{
                              name: itemName,
                              unit_amount: {
                                  value: '10.00',
                                  currency_code: 'USD'
                              },
                              quantity: seatCount.toString()
                          }]
                      }]
                  });
              },
              onApprove: function(data, actions) {
                  logDebug('PayPal payment approved', data);
                  return actions.order.capture().then(function(details) {
                      logDebug('Payment captured', details);
                      showMessage(`🎉 Payment successful! Your reservation for ${seatCount} seat${seatCount > 1 ? 's' : ''} on ${selectedDate} has been confirmed. You will receive a confirmation email shortly.`, 'success');
                      
                      // Refresh availability after successful payment
                      setTimeout(() => {
                          loadEvents();
                      }, 2000);
                  });
              },
              onError: function(err) {
                  logDebug('PayPal Error:', err);
                  showMessage('❌ Payment failed. Please try again or contact support.', 'error');
              },
              onCancel: function(data) {
                  logDebug('PayPal payment cancelled', data);
                  showMessage('Payment was cancelled. Your reservation was not completed.', 'error');
              },
              style: {
                  layout: 'vertical',
                  color: 'black',
                  shape: 'rect',
                  label: 'pay',
                  height: 55
              }
          }).render('#paypal-button-container');
      }

      // Initialize the app when page loads
      document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
